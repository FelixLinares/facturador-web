<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Historial de Sesiones ¬∑ Facturador FL</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{--bg:#060b18;--card:#0d1526;--card2:#111d35;--border:#1a2a45;
      --accent:#4f8bff;--text:#dce6f8;--muted:#5a7099;
      --success:#22d3a0;--danger:#ff4d6a;--warn:#f59e0b;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
    .dots{position:fixed;inset:0;pointer-events:none;z-index:0;
      background-image:radial-gradient(rgba(79,139,255,.05) 1px,transparent 1px);
      background-size:28px 28px;}

    nav{position:sticky;top:0;z-index:100;background:rgba(6,11,24,.92);
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;
      padding:13px 24px;backdrop-filter:blur(12px);}
    .nav-left{display:flex;align-items:center;gap:10px;}
    .nav-icon{width:34px;height:34px;background:linear-gradient(135deg,#4f8bff,#7c5cff);
      border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;}
    .nav-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;}
    .nav-tag{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.6px;
      padding:2px 9px;border-radius:999px;
      background:rgba(79,139,255,.12);color:#4f8bff;border:1px solid rgba(79,139,255,.22);}
    .btn-nav{background:rgba(255,255,255,.05);border:1px solid var(--border);
      color:var(--muted);padding:6px 13px;border-radius:7px;font-size:12px;cursor:pointer;
      display:flex;align-items:center;gap:5px;font-family:'DM Sans',sans-serif;transition:.2s;}
    .btn-nav:hover{background:rgba(255,255,255,.09);color:var(--text);}

    .main{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:24px 20px;}

    .page-header{background:linear-gradient(135deg,rgba(79,139,255,.15),rgba(124,92,255,.1));
      border:1px solid rgba(79,139,255,.2);border-radius:16px;padding:24px 28px;
      margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;
      flex-wrap:wrap;gap:14px;}
    .ph-left h1{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;
      background:linear-gradient(135deg,#dce6f8,#4f8bff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .ph-left p{color:var(--muted);font-size:12px;margin-top:4px;}

    /* Filters */
    .filters-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center;}
    .filter-btn{background:rgba(255,255,255,.04);border:1px solid var(--border);
      color:var(--muted);padding:7px 14px;border-radius:8px;
      font-size:12px;font-weight:600;cursor:pointer;
      font-family:'DM Sans',sans-serif;transition:.2s;}
    .filter-btn:hover{color:var(--text);}
    .filter-btn.active{background:rgba(79,139,255,.12);border-color:rgba(79,139,255,.3);color:#4f8bff;}
    .search-wrap{flex:1;min-width:180px;position:relative;}
    .search-wrap i{position:absolute;left:11px;top:50%;transform:translateY(-50%);
      color:var(--muted);font-size:12px;}
    .search-input{width:100%;background:var(--card);border:1px solid var(--border);
      border-radius:8px;padding:8px 12px 8px 32px;font-size:12px;color:var(--text);
      font-family:'DM Sans',sans-serif;outline:none;transition:.2s;}
    .search-input:focus{border-color:var(--accent);}
    .search-input::placeholder{color:var(--muted);}

    /* Stats */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px;}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;
      padding:14px 16px;display:flex;align-items:center;gap:12px;}
    .stat-ic{width:38px;height:38px;border-radius:10px;flex-shrink:0;
      display:flex;align-items:center;justify-content:center;font-size:16px;}
    .stat-val{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;}
    .stat-lbl{font-size:10px;color:var(--muted);}

    /* Table */
    .table-wrap{background:var(--card);border:1px solid var(--border);
      border-radius:14px;overflow:hidden;}
    .table-wrap table{width:100%;border-collapse:collapse;}
    .table-wrap thead th{
      background:linear-gradient(135deg,rgba(79,139,255,.15),rgba(124,92,255,.08));
      padding:11px 14px;font-size:9px;font-weight:800;
      color:#4f8bff;text-transform:uppercase;letter-spacing:.6px;
      text-align:left;border-bottom:1px solid var(--border);}
    .table-wrap tbody tr{border-bottom:1px solid rgba(255,255,255,.04);transition:.15s;}
    .table-wrap tbody tr:last-child{border-bottom:none;}
    .table-wrap tbody tr:hover{background:rgba(79,139,255,.04);}
    .table-wrap td{padding:11px 14px;font-size:13px;vertical-align:middle;}
    .td-empty{text-align:center;color:var(--muted);padding:48px!important;}

    /* Badges */
    .badge{font-size:10px;font-weight:700;padding:3px 10px;border-radius:999px;
      text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;}
    .b-exitoso {background:rgba(34,211,160,.12);color:#22d3a0;border:1px solid rgba(34,211,160,.25);}
    .b-fallido  {background:rgba(255,77,106,.12); color:#ff4d6a;border:1px solid rgba(255,77,106,.25);}
    .b-cierre   {background:rgba(90,112,153,.12); color:#8ba3c7;border:1px solid rgba(90,112,153,.25);}
    .b-bloqueado{background:rgba(245,158,11,.12); color:#f59e0b;border:1px solid rgba(245,158,11,.25);}

    .user-pill{display:inline-flex;align-items:center;gap:7px;}
    .user-av{width:28px;height:28px;border-radius:50%;
      background:linear-gradient(135deg,#4f8bff,#7c5cff);
      display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:700;flex-shrink:0;}
    .user-info .uname{font-weight:600;font-size:13px;}
    .user-info .uuser{font-size:11px;color:var(--muted);}

    .td-date{font-size:11px;color:var(--muted);}
    .td-ip{font-size:11px;color:var(--muted);font-family:monospace;}
    .td-device{font-size:13px;}

    /* Mobile cards */
    .log-cards{display:none;flex-direction:column;gap:10px;}
    .log-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .lc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .lc-meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;}
    .lc-meta span{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}

    @media(max-width:700px){
      .table-wrap{display:none;}
      .log-cards{display:flex;}
      .stats-row{grid-template-columns:repeat(2,1fr);}
      nav{padding:10px 14px;}
      .nav-tag{display:none;}
      .main{padding:14px 12px;}
      .page-header{padding:16px;}
      .ph-left h1{font-size:18px;}
      .filters-bar{gap:6px;}
      .filter-btn{padding:6px 10px;font-size:11px;}
    }
    @media(max-width:400px){
      .stats-row{grid-template-columns:1fr 1fr;}
      .stat-val{font-size:18px;}
    }
  </style>
</head>
<body>
  <div class="dots"></div>

  <nav>
    <div class="nav-left">
      <div class="nav-icon">üîê</div>
      <span class="nav-title">Historial de Sesiones</span>
      <span class="nav-tag">Seguridad</span>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn-nav" onclick="loadLogs()"><i class="fa fa-rotate-right"></i> Actualizar</button>
      <button class="btn-nav" onclick="location.href='/dashboard'"><i class="fa fa-grid-2"></i> Dashboard</button>
    </div>
  </nav>

  <div class="main">
    <div class="page-header">
      <div class="ph-left">
        <h1>Historial de Inicio de Sesi√≥n</h1>
        <p>Registro completo de accesos, intentos fallidos y cierres de sesi√≥n</p>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-ic" style="background:rgba(34,211,160,.12)"><i class="fa fa-circle-check" style="color:#22d3a0"></i></div>
        <div><div class="stat-val" id="stExito" style="color:#22d3a0">0</div><div class="stat-lbl">Exitosos</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-ic" style="background:rgba(255,77,106,.12)"><i class="fa fa-circle-xmark" style="color:#ff4d6a"></i></div>
        <div><div class="stat-val" id="stFallido" style="color:#ff4d6a">0</div><div class="stat-lbl">Fallidos</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-ic" style="background:rgba(90,112,153,.12)"><i class="fa fa-right-from-bracket" style="color:#8ba3c7"></i></div>
        <div><div class="stat-val" id="stCierre" style="color:#8ba3c7">0</div><div class="stat-lbl">Cierres</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-ic" style="background:rgba(245,158,11,.12)"><i class="fa fa-user-lock" style="color:#f59e0b"></i></div>
        <div><div class="stat-val" id="stBloq" style="color:#f59e0b">0</div><div class="stat-lbl">Bloqueados</div></div>
      </div>
    </div>

    <div class="filters-bar">
      <button class="filter-btn active" data-f="">Todos</button>
      <button class="filter-btn" data-f="exitoso">‚úÖ Exitosos</button>
      <button class="filter-btn" data-f="fallido">‚ùå Fallidos</button>
      <button class="filter-btn" data-f="cierre">üö™ Cierres</button>
      <button class="filter-btn" data-f="bloqueado">üîí Bloqueados</button>
      <div class="search-wrap">
        <i class="fa fa-magnifying-glass"></i>
        <input id="searchInput" class="search-input" placeholder="Buscar usuario...">
      </div>
    </div>

    <!-- Desktop table -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Estado</th>
            <th>Dispositivo</th>
            <th>IP</th>
            <th>Fecha y Hora</th>
          </tr>
        </thead>
        <tbody id="logTbody"></tbody>
      </table>
    </div>

    <!-- Mobile cards -->
    <div class="log-cards" id="logCards"></div>
  </div>

  <div style="text-align:center;padding:16px;border-top:1px solid var(--border);position:relative;z-index:1">
    <div style="font-size:11px;color:#1e2d4a;margin-bottom:6px">¬© 2026 Felix Linares ¬∑ Todos los derechos reservados</div>
    <a href="https://wa.me/573183979833" target="_blank"
      style="display:inline-flex;align-items:center;gap:6px;background:rgba(37,211,102,.08);border:1px solid rgba(37,211,102,.2);color:#25d366;padding:6px 14px;border-radius:999px;font-size:11px;font-weight:600;text-decoration:none">
      <i class="fab fa-whatsapp"></i> Soporte
    </a>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const user  = JSON.parse(localStorage.getItem("user")||"null");
    if(!token||!user){location.href="/";}
    const AUTH  = {Authorization:`Bearer ${token}`};
    const isAdmin = user.role==="admin";
    const $ = id => document.getElementById(id);

    let allLogs=[], activeFilter="";

    function fmtDate(d){
      const dt=new Date(d);
      return dt.toLocaleDateString("es-CO",{day:"2-digit",month:"2-digit",year:"numeric"})
        +" "+dt.toLocaleTimeString("es-CO",{hour:"2-digit",minute:"2-digit"});
    }

    async function loadLogs(){
      const url = isAdmin ? "/api/admin/login-logs" : "/api/auth/my-logs";
      const res = await fetch(url,{headers:AUTH});
      if(res.status===401){location.href="/";return;}
      const {logs}=await res.json();
      allLogs=logs;
      renderStats(logs);
      renderLogs(logs);
    }

    function renderStats(logs){
      $("stExito").textContent  = logs.filter(l=>l.status==="exitoso").length;
      $("stFallido").textContent= logs.filter(l=>l.status==="fallido").length;
      $("stCierre").textContent = logs.filter(l=>l.status==="cierre").length;
      $("stBloq").textContent   = logs.filter(l=>l.status==="bloqueado").length;
    }

    function renderLogs(logs){
      // Table
      const tb=$("logTbody"); tb.innerHTML="";
      if(!logs.length){
        tb.innerHTML=`<tr><td colspan="5" class="td-empty">
          <i class="fa fa-shield-halved" style="font-size:28px;display:block;margin-bottom:10px;opacity:.3"></i>
          No hay registros</td></tr>`;
      } else {
        logs.forEach(l=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td><div class="user-pill">
              <div class="user-av">${(l.name||"?")[0].toUpperCase()}</div>
              <div class="user-info">
                <div class="uname">${l.name}</div>
                <div class="uuser">@${l.username}</div>
              </div>
            </div></td>
            <td><span class="badge b-${l.status}">${l.status}</span></td>
            <td class="td-device">${l.device||"‚Äì"}</td>
            <td class="td-ip">${l.ip||"‚Äì"}</td>
            <td class="td-date">${fmtDate(l.created_at)}</td>`;
          tb.appendChild(tr);
        });
      }

      // Mobile cards
      const cards=$("logCards"); cards.innerHTML="";
      if(!logs.length){
        cards.innerHTML=`<div style="text-align:center;color:var(--muted);padding:40px">Sin registros</div>`;
      } else {
        logs.forEach(l=>{
          const div=document.createElement("div");
          div.className="log-card";
          div.innerHTML=`
            <div class="lc-top">
              <div class="user-pill">
                <div class="user-av">${(l.name||"?")[0].toUpperCase()}</div>
                <div class="user-info">
                  <div class="uname">${l.name}</div>
                  <div class="uuser">@${l.username}</div>
                </div>
              </div>
              <span class="badge b-${l.status}">${l.status}</span>
            </div>
            <div class="lc-meta">
              <span><i class="fa fa-clock"></i> ${fmtDate(l.created_at)}</span>
              <span>${l.device||"‚Äì"}</span>
              <span><i class="fa fa-network-wired"></i> ${l.ip||"‚Äì"}</span>
            </div>`;
          cards.appendChild(div);
        });
      }
    }

    // Filters
    document.querySelectorAll(".filter-btn").forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        activeFilter=btn.dataset.f;
        applyFilters();
      };
    });

    $("searchInput").oninput=applyFilters;

    function applyFilters(){
      const q=$("searchInput").value.toLowerCase();
      let logs=allLogs;
      if(activeFilter) logs=logs.filter(l=>l.status===activeFilter);
      if(q) logs=logs.filter(l=>
        l.name.toLowerCase().includes(q)||l.username.toLowerCase().includes(q)
      );
      renderLogs(logs);
    }

    loadLogs();
  </script>
</body>
</html>
